@startuml Диаграмма состояний - Состояния приложения
!theme plain

[*] --> Инициализация : Запуск приложения

Инициализация --> ПроверкаКонфигурации : Загрузить конфигурацию

ПроверкаКонфигурации --> ЛокальныйРежим : USE_LOCAL_STORAGE = true
ПроверкаКонфигурации --> РежимS3 : USE_LOCAL_STORAGE = false

state ЛокальныйРежим {
  [*] --> ИнициализацияХранилища
  ИнициализацияХранилища --> ХранилищеГотово : Хранилище инициализировано
  ХранилищеГотово --> ОбработкаЗапроса : API запрос
  ОбработкаЗапроса --> ХранилищеГотово : Запрос выполнен
}

state РежимS3 {
  [*] --> ПроверкаCredentials
  ПроверкаCredentials --> CredentialsВалидны : Валидные credentials
  ПроверкаCredentials --> CredentialsНевалидны : Невалидные credentials
  CredentialsВалидны --> S3Готово : S3 подключен
  S3Готово --> ОбработкаЗапроса : API запрос
  ОбработкаЗапроса --> S3Готово : Запрос выполнен
  CredentialsНевалидны --> [*] : Состояние ошибки
}

ЛокальныйРежим --> Готово : Хранилище готово
РежимS3 --> Готово : S3 готов

Готово --> ОбработкаЗапроса : Получен API запрос

state ОбработкаЗапроса {
  [*] --> Валидация
  Валидация --> Обработка : Валидный запрос
  Валидация --> Ошибка400 : Невалидный запрос
  Обработка --> Успех : Операция успешна
  Обработка --> Ошибка500 : Операция не удалась
  Успех --> [*]
  Ошибка400 --> [*]
  Ошибка500 --> [*]
}

ОбработкаЗапроса --> Готово : Ответ отправлен

Готово --> [*] : Завершение приложения

note right of ЛокальныйРежим
  Файлы хранятся в:
  storage/files/
  storage/metadata/
end note

note right of РежимS3
  Файлы хранятся в:
  AWS S3 Bucket
end note

@enduml
